@page "/product/{ProductId:guid}"
@using AutoPartsShop.Infrastructure
@inject IProductService ProductService
@inject ICartService CartService
@inject MessageService MessageService
@inject AuthenticationStateProvider AuthenticationStateProvider

@if (_product == null)
{
    <Spin Spinning="true" Tip="加载中..." />
}
else
{
    <Breadcrumb>
        <BreadcrumbItem>
            <a href="/">首页</a>
        </BreadcrumbItem>
        <BreadcrumbItem>
            <a href="/products">汽修配件</a>
        </BreadcrumbItem>
        <BreadcrumbItem>@_product.Name</BreadcrumbItem>
    </Breadcrumb>

    <Row Gutter="16" Style="margin-top: 24px;">
        <Col Span="12">
            <Image Preview="true" 
                   Width="100%" 
                   Src="@_product.MainImage" 
                   Fallback="https://via.placeholder.com/400x400?text=No+Image" />
            <div class="product-gallery" Style="display: flex; margin-top: 16px;">
                @if (!string.IsNullOrEmpty(_product.MainImage))
                {
                    <Image Width="80" 
                           Height="80" 
                           Src="@_product.MainImage" 
                           Style="margin-right: 8px; cursor: pointer;" 
                           PreviewSrc="@_product.MainImage" />
                }
                @foreach (var image in _product.Images)
                {
                    <Image Width="80" 
                           Height="80" 
                           Src="@image" 
                           Style="margin-right: 8px; cursor: pointer;" 
                           PreviewSrc="@image" />
                }
            </div>
        </Col>
        <Col Span="12">
            <h1 Style="font-size: 24px; margin-bottom: 16px;">@_product.Name</h1>
            <div class="product-meta" Style="display: flex; align-items: center;">
                <span Style="color: #999;">配件编号: @_product.PartNumber</span>
                <Divider Type="vertical" />
                <Rate Value="@_product.AverageRating" Disabled="true" />
                <span Style="margin-left: 8px;">(@_product.ReviewCount 条评价)</span>
                <Divider Type="vertical" />
                <span>销量: @_product.SalesCount 件</span>
            </div>
            <Divider />
            <div class="product-price" Style="margin: 16px 0;">
                <span class="current-price" Style="color: #cf1322; font-size: 24px; font-weight: bold;">¥@_product.Price.ToString("N2")</span>
                @if (_product.OriginalPrice > _product.Price)
                {
                    <span class="original-price" Style="color: #999; text-decoration: line-through; margin-left: 8px;">¥@_product.OriginalPrice.ToString("N2")</span>
                }
            </div>
            <div class="product-stock" Style="margin-bottom: 16px;">库存: @_product.Stock 件</div>
            
            <Divider>适配车型</Divider>
            <div class="fitment-info" Style="margin-bottom: 24px;">
                <Tag>@_product.CarBrandName</Tag>
                <Tag>@_product.CarModelName (@_product.CarModelYear)</Tag>
                <div Style="margin-top: 8px;">@_product.Fitment</div>
            </div>
            
            <Divider>购买数量</Divider>
            <InputNumber Min="1" 
                         Max="@_product.Stock" 
                         Value="@_quantity" 
                         OnChange="@HandleQuantityChange" 
                         Style="width: 150px; margin-bottom: 24px;" />
            
            <div class="product-actions" Style="display: flex;">
                <Button Type="primary" 
                        Size="large" 
                        Icon="shopping-cart" 
                        Style="flex: 1; margin-right: 16px;"
                        OnClick="@AddToCart">加入购物车</Button>
                <Button Type="default" 
                        Size="large" 
                        Icon="shopping" 
                        Style="flex: 1;"
                        OnClick="@BuyNow">立即购买</Button>
            </div>
            
            <Divider>商品详情</Divider>
            <div class="product-description" Style="line-height: 1.6;">@((MarkupString)_product.Description)</div>
        </Col>
    </Row>
    
    <Divider Style="margin: 32px 0;">用户评价</Divider>
    <ReviewList ProductId="@_productId" />
}

@code {
    [Parameter]
    public Guid ProductId { get; set; }
    
    private ProductDetailDto _product;
    private int _quantity = 1;
    private Guid _productId;
    
    protected override async Task OnParametersSetAsync()
    {
        _productId = ProductId;
        await LoadProduct();
    }
    
    private async Task LoadProduct()
    {
        _product = await ProductService.GetProductDetailAsync(_productId);
        if (_product == null)
        {
            await MessageService.Error("商品不存在或已下架");
            NavigationManager.NavigateTo("/products");
        }
    }
    
    private void HandleQuantityChange(int value)
    {
        _quantity = value;
    }
    
    private async Task AddToCart()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (!authState.User.Identity.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }
        
        await CartService.AddToCart(_productId, _quantity);
        await MessageService.Success("已加入购物车");
    }
    
    private async Task BuyNow()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (!authState.User.Identity.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }
        
        await CartService.AddToCart(_productId, _quantity);
        NavigationManager.NavigateTo("/cart");
    }
}