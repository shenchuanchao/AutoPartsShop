@using Microsoft.AspNetCore.Components.Authorization
@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
<AntDesign.Layout Class="layout">
	<AntDesign.Header Class="header-content">
		<div class="logo" Style="color: white; font-size: 20px; margin-right: 20px;">
			<Icon Type="car" Theme="IconThemeType.Fill" Style="font-size: 24px; margin-right: 10px;" />
			汽修配件商城
		</div>
		<div class="search-bar">
			<Search @bind-Value="@searchText" Placeholder="搜索配件、品牌、型号..." Size="InputSize.Large" Style="border-radius: 20px;" AllowClear />
			@* <Input @bind-Value="@searchText" Placeholder="搜索配件、品牌、型号..." Size="InputSize.Large" Style="border-radius: 20px;" AllowClear>
			<Suffix>
				<Button Type="ButtonType.Primary" Shape="ButtonShape.Circle" Icon="search" OnClick="HandleSearch" />
			</Suffix>
			</Input> *@
		</div>
		<div class="nav-links">
			<Menu Mode="MenuMode.Horizontal" Theme="MenuTheme.Dark" Style="flex: 1; min-width: 0;">
				<MenuItem>
					<NavLink href="/">
						<Icon Type="home" />
						首页
					</NavLink>
				</MenuItem>
				<MenuItem>
					<NavLink onclick="()=>ShowCart()">
						<Icon Type="shopping-cart" />
						购物车
					</NavLink>
				</MenuItem>
				@if (_userIsAuthenticated)
				{
					<MenuItem>
						<Dropdown>
							<ChildContent>
								<Space Align="SpaceAlign.Center">
									<Avatar Icon="user" />
									<span>@_userName</span>
								</Space>
							</ChildContent>
							<Overlay>
								<Menu Style="width: 150px;">
									<MenuItem>
										<NavLink href="/account/profile">个人中心</NavLink>
									</MenuItem>
									<MenuItem>
										<NavLink href="/account/orders">我的订单</NavLink>
									</MenuItem>
									@if (_isAdmin)
									{
										<MenuDivider />
										<MenuItem>
											<NavLink href="/admin/dashboard">后台管理</NavLink>
										</MenuItem>
									}
									<MenuDivider />
									<MenuItem OnClick="@Logout">
										<Space >
											<Icon Type="logout" />
											<span>退出登录</span>
										</Space>
									</MenuItem>
								</Menu>
							</Overlay>
						</Dropdown>
					</MenuItem>
				}
				else
				{
					<MenuItem>
						<NavLink href="/account">
							<Icon Type="user" />
							我的账户
						</NavLink>
					</MenuItem>
				}
				<MenuItem>
					<NavLink onclick="ShowCustomerService">
						<Icon Type="customer-service" />
						客服
					</NavLink>
				</MenuItem>
			</Menu>
			
		</div>

	</AntDesign.Header>

	<AntDesign.Content Style="padding: 0 50px; margin-top: 16px;">
		<Breadcrumb Style="margin: 16px 0;">
			@* <BreadcrumbItem>首页</BreadcrumbItem> *@
			@if (CurrentPage == "Products")
			{
				<BreadcrumbItem>商品中心</BreadcrumbItem>
			}
			else if (CurrentPage == "Cart")
			{
				<BreadcrumbItem>购物车</BreadcrumbItem>
			}
			<!-- 其他页面的面包屑 -->
		</Breadcrumb>

		<div Class="site-layout-content">
			@Body
		</div>
	</AntDesign.Content>

	<AntDesign.Footer Style="text-align: center;">
		汽修配件商城 ©2023 Created by AutoPartsShop
	</AntDesign.Footer>
</AntDesign.Layout>

@code {
	private string searchText = "";
	private string CurrentPage => NavigationManager.ToAbsoluteUri(NavigationManager.Uri).AbsolutePath;
	private bool _userIsAuthenticated;
	private string _userName = "用户";
	private bool _isAdmin;


	[Inject] private NavigationManager NavigationManager { get; set; }
	[Inject] private ApiAuthenticationStateProvider ApiAuthenticationStateProvider { get; set; }

	protected override async Task OnInitializedAsync()
	{
		await LoadUserState();
	}

	private async Task HandleSearch()
	{
		if (string.IsNullOrWhiteSpace(searchText))
		{
			await JSRuntime.InvokeVoidAsync("myJsHelpers.showNotification",
					"请输入搜索关键词", "error");
			return;
		}

		NavigationManager.NavigateTo($"/search?q={searchText}");
	}

	private async Task LoadUserState()
	{
		var authState = await ApiAuthenticationStateProvider.GetAuthenticationStateAsync();
		_userIsAuthenticated = authState.User.Identity.IsAuthenticated;

		if (_userIsAuthenticated)
		{
			_userName = authState.User.Identity.Name;
			_isAdmin = authState.User.IsInRole("Admin");
		}
	}

	private async Task Logout()
	{
		ApiAuthenticationStateProvider.MarkUserAsLoggedOut();
		NavigationManager.NavigateTo("/");
	}

	void ShowCart()
	{
		NavigationManager.NavigateTo("/cart");
	}
	void ShowCustomerService()
	{
		NavigationManager.NavigateTo("/customer-service");
	}
}
